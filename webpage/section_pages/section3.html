<!DOCTYPE html>
    <html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Database App</title>

        <!-- Custom page stlyings -->
        <link href="../stylings.css" rel="stylesheet">

        <!-- Javascript -->
        <!-- 
            Consider wrapping some of the menu to make the index.html less busy
            <script src="./menu.js" type="text/javascript"></script>
        --> 
        <script type="module" src="../supporting_modules/SlideShow.js"></script>
        <script type="module" src="../supporting_modules/run_queries.js"></script>
        <script type="module" src="../supporting_modules/set-tv-content.js"></script>


        <!-- SQL.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/0.2.4/js/sql.js"></script>

        <!-- jQuery and jQuery-UI -->
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

        <!-- Bootstrap CSS CDN -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

        <!-- Font Awesome JS -->
        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>

        <!-- jQuery CDN - Slim version (=without AJAX) -->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
        <!-- Popper.JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
        <!-- Bootstrap JS -->
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    </head>

    <body>

        <!-- <h1>Lets make some sidebarsssss</h1> -->

        <!-- Div that contains the web page -->
        <div class="wrapper">

            <!--
                Sidebar is a nav element
                The sidebar can contain a header div called sidebar-header
                The sidebar must contain an unordered that can be nested.
                When nesting this list, specific items can have the below:
                    -> Collapsable via the data-toggle attribute.
                    -> Class for dropdown-toggle.
                    -> Items here have class "collapse type".
                    -> The nest can the content of a link.
            -->
            <nav id="sidebar">
                <div class="sidebar-header">
                    <h3>HR Database App</h3>
                </div>
        
                <ul class="list-unstyled components">
                    <p>Choose Query By Section</p>
                    <li class="active">
                        <a href="#section3_menu" data-toggle="collapse" class="dropdown-toggle" aria-expanded="false">Section 3 Queries</a>
                        <ul class="collapse list-unstyled" id="section3_menu">
                            <li id="Query1">
                                <a class="SectionQuery" id="Section3_Query1" href="#">Query 1</a>
                            </li>
                            <li id="Query2">
                                <a class="SectionQuery" id="Section3_Query2" href="#">Query 2</a>
                            </li>
                            <li id="Query3">
                                <a class="SectionQuery" id="Section3_Query3" href="#">Query 3</a>
                            </li>
                        </ul>
                    </li>
                </ul>

                <!--
                    Run 'em All Button

                    <div class="d-flex justify-content-center">
                        <button type="button" id="runAllQueries" class="btn btn-success">
                            <span>Run All Queries</span>
                        </button>
                    </div>
                -->
            </nav>

            <!-- Navbar containing toggle button and page links -->
            <div id="content">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container-fluid">
            
                        <!-- Toggle button -->
                        <button type="button" id="sidebarCollapse" class="btn btn-info">
                            <i class="fas fa-align-left"></i>
                            <span>Toggle Sidebar</span>
                        </button>

                        <button id="toggleSidebar" class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <i class="fas fa-align-justify"></i>
                            <span>View Pages</span>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="nav navbar-nav ml-auto">
                                <li class="nav-item">
                                    <a class="nav-link SectionID" href="./section1.html">Section 1</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link SectionID" href="./section2.html">Section 2</a>
                                </li>
                                <li class="nav-item active">
                                    <a class="nav-link SectionID" href="#">Section 3</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <!-- TV Div Template (see index.html for notes) -->
                <br>
                <div class="tv container" id="tvDiv">

                    <!-- Navigate channels -->
                    <div class="tv-nav" id="tv-left"><span class="tv-chan" id="chanLeft">&#60;</span></div>
                    <div class="tv-nav" id="tv-right"><span class="tv-chan" id="chanRight">&#62;</span></div>

                    <!-- Screen -->
                    <div class="tv-content">
                        <div class="tv-screen container-fluid">
                        </div>
                    </div>

                    <!-- TV Buttons -->
                    <div class="tv-btns">

                        <!-- Go to first -->
                        <button type="button" id="prevQ" class="btn btn-primary">
                            <span>Previous</span>
                        </button>

                        <!--
                            Run Query
                                - Will get the content of the active queryBlock
                        -->
                        <button type="button" id="runQuery" class="btn btn-success">
                            <span>Run Query</span>
                        </button>

                        <!--
                            Reset
                                - Will set the results block to Pending / Empty
                        -->
                        <button type="button" id="resetBtn" class="btn btn-danger">
                            <span>Reset</span>
                        </button>

                        <!-- Go to last -->
                        <button type="button" id="nextQ" class="btn btn-primary">
                            <span>Next</span>
                        </button>
                    </div>
                </div>
            </div>        
        </div>

        <!--
            Get database, page content, add functions to buttons
              & raise alerts during database download or active query
        -->
        <script type="module">

            // Import modules
            import SlideShow from '../supporting_modules/SlideShow.js';
            import {manageQueries} from '../supporting_modules/run_queries.js';
            import {set_TV_Loader, set_TV_PendingResults, setTargetContent, default_ResultsBlock, navAlert} from '../supporting_modules/set-tv-content.js';

            // Initalize required variables
            let xhttp, updated;
            let slides, empDB;
            set_TV_Loader();
            let activeQuery = false;
            let databaseLoaded = false;
            slides = new SlideShow();

            // Request database
            let db_xhttp = new XMLHttpRequest();
            db_xhttp.open("GET", "../database/employees.db", true);
            db_xhttp.responseType = 'arraybuffer';
            db_xhttp.send();
            db_xhttp.onreadystatechange = function() {
                if (db_xhttp.readyState == 4 && db_xhttp.status == 200) {

                    // Instantiate db object from response
                    console.log("\nSetting up database");
                    empDB = new Uint8Array(db_xhttp.response);
                    set_TV_PendingResults();

                    // Update content from the TV-Div
                    setTargetContent(slides, "#blockHeading", "Label");
                    setTargetContent(slides, "#queryBlock", "Query");
                    databaseLoaded = true;
                }
            };

            // Make page interactive once loaded
            $(document).ready(function () {

                // Toggle the sidebar
                $('#sidebarCollapse').on('click', function () {
                    $('#sidebar').toggleClass('active');
                });

                // Populate the Slide-Show.js with CMS data
                // & and serve this content to the webapp
                xhttp = new XMLHttpRequest();
                xhttp.open("GET", "../queries/full-set.json", true);
                xhttp.send();
                xhttp.onreadystatechange = function() {

                    // Update when ready
                    // Encountered issues when encapsulated within CMS.js
                    if (xhttp.readyState == 4 && xhttp.status == 200) {

                        // Initalize variables
                        let sectionID = "Section3";
                        let listElm, queryID, queryLabel, query, menuID;

                        // Update the slides
                        let dataset = JSON.parse(xhttp.responseText);
                        dataset = { "Section3": dataset[sectionID] };
                        slides.setdataset(dataset);

                        // Update sidebar
                        for(queryID in slides.getDataset()[sectionID] ) {

                            // Set menu id
                            menuID=`${sectionID}_${queryID}`;
                            queryLabel = slides.getDataset()[sectionID][queryID]["Label"];

                            // Add to list if not already there
                            if($(`#${queryID}`).length < 1 ) {
                                listElm = `
                                    <li id="${queryID}">
                                        <a class="SectionQuery" id="${menuID}" href="#">${queryLabel}</a>
                                    </li>
                                `;
                                $("#section_menu").append(listElm);
                            }

                            // Otherwise add element
                            else {
                                $(`#${menuID}`).text( queryLabel );
                            }
                        }
                        xhttp = null;
                    }
                };

                // Display content of previous page
                $("#prevQ").click( function () {

                    // Print alert or migrate
                    if( !databaseLoaded || activeQuery ) {
                        navAlert();
                    }

                    else {

                        // Move in the slides
                        slides.goToPreviousPage();

                        // Update content
                        setTargetContent(slides, "#blockHeading", "Label");
                        setTargetContent(slides, "#queryBlock", "Query");

                        // Update the results table
                        default_ResultsBlock();
                    }

                });

                // Display content of next page
                $("#nextQ").click( function () {

                    // Print alert or migrate
                    if( !databaseLoaded || activeQuery ) {
                        navAlert();
                    }

                    else {

                        // Move in the slides
                        slides.goToNextPage();

                        // Update content
                        setTargetContent(slides, "#blockHeading", "Label");
                        setTargetContent(slides, "#queryBlock", "Query");

                        // Update the results table
                        default_ResultsBlock();
                    }
                });


                // Display first page of next section
                $("#chanRight").click( function () {

                    // Block section changes
                    window.alert("Please Use the Navigation bar to move between section in this view. This is to prevent accidental moves");
                });


                // Display first page of previous section
                $("#chanLeft").click( function () {

                    // Block section changes
                    window.alert("Please Use the Navigation bar to move between section in this view. This is to prevent accidental moves");
                });


                // Handle selecting list class items
                $(document).delegate(".SectionQuery", "click", function () {

                    // Print alert or migrate
                    if( !databaseLoaded || activeQuery ) {
                        navAlert();
                    }

                    else {

                        // Initalize variables
                        let elmID, section, query, data;

                        // Get elementID to set position
                        elmID = this.id;
                        section = elmID.split("_")[0];
                        query = elmID.split("_")[1];
                        
                        // Set postion in slide show
                        slides.goToPage(section, query);

                        // Update content
                        setTargetContent(slides, "#blockHeading", "Label");
                        setTargetContent(slides, "#queryBlock", "Query");

                        // Update the results table
                        default_ResultsBlock();

                    }
                });


                // Handle executing queries
                $("#runQuery").click(function() {

                    // Print alert or migrate
                    if( !databaseLoaded || activeQuery) {
                        navAlert();
                    }

                    else {

                        // Get the active section
                        let data;
                        activeQuery = true;
                        data = slides.getActiveElement();

                        // Delegate handling the query + table div to run_queries.
                        manageQueries(empDB, data['Query']);
                        activeQuery = false;
                    } 
                });


                // Reset table
                $("#resetBtn").click( function() {

                    // Print alert or migrate
                    if( !databaseLoaded || activeQuery) {
                        navAlert();
                    }

                    else {
                        default_ResultsBlock();
                    }
                });
            });

        </script>
    </body>

</html>